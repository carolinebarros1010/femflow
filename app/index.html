<!DOCTYPE html>
<html lang="pt-BR">

<head>
<base href="/app/" />

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <script src="./config/config.js"></script>
  <title>Entrar no FemFlow</title>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.ico">
  <meta name="msapplication-TileImage" content="favicon.ico">

  <link rel="preconnect" href="https://accounts.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://accounts.google.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://femflowapi.falling-wildflower-a8c0.workers.dev" crossorigin>
  <link rel="dns-prefetch" href="https://femflowapi.falling-wildflower-a8c0.workers.dev">


  <script>window.FEMFLOW_DISABLE_UI = true;</script>
  <script defer src="./core/femflow-core.js"></script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script defer src="services/firebase-init.js?v=20250127"></script>

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/core.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/login.css">

</head>

<body class="login-page">

  <div class="login-wrapper">
    <div class="login-card">

      <img src="assets/logofemflowterracotasf.png" class="logo"/>

      <h2 id="tLoginBemVinda">Bem-vinda</h2>
      <p class="subtitle" id="tLoginSub">Acesse ou crie sua conta para iniciar seu ciclo</p>

      <button id="btnLoginLang" class="login-lang-btn">ğŸŒ PortuguÃªs</button>

      <input id="loginEmail" type="email" placeholder="Seu e-mail"/>

      <div class="password-wrapper">
        <input id="loginSenha" type="password" placeholder="Sua senha">
        <span id="toggleSenha" class="toggle-eye"></span>
        <div class="password-strength">
          <div id="strengthFill" class="password-strength-fill"></div>
        </div>
      </div>

      <button id="btnEntrar" type="button">Entrar</button>
      <p id="mensagem" class="message"></p>

      <a id="linkCadastro" class="toggle" href="anamnese_deluxe.html">Ainda nÃ£o tem conta? Cadastre-se</a>
      <p id="goRecuperar" class="toggle">Esqueci minha senha</p>

      <div class="social-row boho">
        <div class="social-icon boho google" id="googleSignIn">
          <img src="assets/icons/google-g.svg">
        </div>

        <div class="social-icon boho apple" id="appleSignIn">
          <img src="assets/icons/apple.svg">
        </div>

        <div class="social-icon boho bio" id="bioSignIn">ğŸ”’</div>
      </div>

    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  window.FEMFLOW = window.FEMFLOW || {};

  const scriptURL = FEMFLOW.SCRIPT_URL;

  const $ = sel => document.querySelector(sel);
  const msg = $("#mensagem");

  const setErr = t => { msg.textContent = t; msg.style.color = "#cc6a5a"; };
  const setMsg = (t, ok=false) => {
    msg.textContent = t;
    msg.style.color = ok ? "#2e7d32" : "#335953";
  };

  const currentLoginLang = () => localStorage.getItem("femflow_lang") || "pt";

  const LOGIN_MSG = {
    pt: {
      blocked: "Esta conta jÃ¡ estÃ¡ conectada em outro dispositivo.",
      wrongPass: "Senha incorreta.",
      emailNotFound: "E-mail nÃ£o encontrado."
    },
    en: {
      blocked: "This account is already connected on another device.",
      wrongPass: "Incorrect password.",
      emailNotFound: "Email not found."
    },
    fr: {
      blocked: "Ce compte est dÃ©jÃ  connectÃ© sur un autre appareil.",
      wrongPass: "Mot de passe incorrect.",
      emailNotFound: "E-mail introuvable."
    }
  };

  const getLoginMsg = () => LOGIN_MSG[currentLoginLang()] || LOGIN_MSG.pt;

  function getHotmartContext() {
    const params = new URLSearchParams(window.location.search);
    const origem = String(
      params.get("origem") ||
      params.get("source") ||
      params.get("utm_source") ||
      ""
    ).toLowerCase();

    const email = String(
      params.get("email") ||
      params.get("user_email") ||
      params.get("buyer_email") ||
      ""
    ).trim().toLowerCase();

    const id = String(
      params.get("id") ||
      params.get("hotmart_id") ||
      params.get("subscriber_id") ||
      ""
    ).trim();

    const nome = String(
      params.get("nome") ||
      params.get("name") ||
      params.get("buyer_name") ||
      params.get("user_name") ||
      ""
    ).trim();

    const telefone = String(
      params.get("telefone") ||
      params.get("phone") ||
      params.get("buyer_phone") ||
      params.get("user_phone") ||
      ""
    ).trim();

    const cameFromHotmart = origem.includes("hotmart") || params.has("hotmart") || params.has("hotmart_id");
    return { cameFromHotmart, email, id, nome, telefone };
  }

  const hotmartCtx = getHotmartContext();
  if (!hotmartCtx.cameFromHotmart) {
    const loginSilenciosoOk = await FEMFLOW.autoLoginSilencioso?.();
    if (loginSilenciosoOk) {
      const idSalvo = String(localStorage.getItem("femflow_id") || "").trim();
      const emailSalvo = String(localStorage.getItem("femflow_email") || "").trim();
      const tokenSalvo = String(localStorage.getItem("femflow_session_token") || "").trim();
      const expiraRaw = String(localStorage.getItem("femflow_session_expira") || "").trim();

      const possuiIdentidade = Boolean(idSalvo || emailSalvo);
      const possuiToken = Boolean(tokenSalvo);
      const expiraMs = Date.parse(expiraRaw);
      const tokenValido = !expiraRaw || !Number.isFinite(expiraMs) || expiraMs > Date.now();

      if (possuiIdentidade && possuiToken && tokenValido) {
        location.href = "home.html";
        return;
      }
    }
  }

  function encaminharHotmartParaAnamnese() {
    const ctx = getHotmartContext();
    if (!ctx.cameFromHotmart) return;

    if (ctx.email) {
      $("#loginEmail").value = ctx.email;
      localStorage.setItem("femflow_email", ctx.email);
      localStorage.setItem("lead_email", ctx.email);
    }

    if (ctx.id) {
      localStorage.setItem("femflow_id", ctx.id);
      localStorage.setItem("femflow_hotmart_id", ctx.id);
    }

    if (ctx.nome) {
      localStorage.setItem("lead_nome", ctx.nome);
    }

    if (ctx.telefone) {
      localStorage.setItem("lead_telefone", ctx.telefone);
    }

    const anamneseParams = new URLSearchParams();
    anamneseParams.set("origem", "hotmart");
    if (ctx.email) anamneseParams.set("email", ctx.email);
    if (ctx.id) anamneseParams.set("id", ctx.id);
    if (ctx.nome) anamneseParams.set("nome", ctx.nome);
    if (ctx.telefone) anamneseParams.set("telefone", ctx.telefone);

    setMsg("Redirecionando para completar sua anamnese...");
    setTimeout(() => {
      location.href = `anamnese_deluxe.html?${anamneseParams.toString()}`;
    }, 300);
  }

  let firebaseAuthUser = null;
  let firebaseAuthObserverStarted = false;
  let loginInProgress = false;

  function marcarFallbackFirebaseAuth(causa = "") {
    try {
      localStorage.setItem("femflow_firebase_auth_fallback", "1");
      if (causa) {
        localStorage.setItem("femflow_firebase_auth_fallback_reason", String(causa));
      }
    } catch (_) {}
  }

  function startFirebaseAuthObserver() {
    if (!window.firebase || !firebase.auth || firebaseAuthObserverStarted) return;
    firebaseAuthObserverStarted = true;
    firebase.auth().onAuthStateChanged((user) => {
      firebaseAuthUser = user || null;
    });
  }

  function firebaseConfigHint() {
    const cfg = window.FEMFLOW_ACTIVE?.firebaseConfig || window.FEMFLOW_CONFIG?.firebaseConfig || {};
    return {
      projectId: cfg.projectId || "(nÃ£o definido)",
      authDomain: cfg.authDomain || "(nÃ£o definido)",
      apiKeyPrefix: cfg.apiKey ? `${String(cfg.apiKey).slice(0, 8)}...` : "(nÃ£o definido)"
    };
  }

  async function validarNoGAS(email, senha) {
    return postGAS({
      action: "login",
      email,
      senha,
      deviceId: FEMFLOW.getDeviceId()
    });
  }

  async function syncFirebaseAuthSession(email, senha) {
    if (!window.firebase || !firebase.auth) {
      console.warn("[Login] Firebase Auth indisponÃ­vel. Login seguirÃ¡ apenas com sessÃ£o do backend.");
      try {
        localStorage.setItem("firebase_sync_failed", "true");
      } catch (_) {}
      return;
    }

    const auth = firebase.auth();
    const emailNorm = String(email || "").trim().toLowerCase();
    const senhaNorm = String(senha || "").trim();

    const activeUser = auth.currentUser;
    const activeEmail = String(activeUser?.email || "").trim().toLowerCase();

    if (activeUser && activeEmail === emailNorm) {
      return;
    }

    if (activeUser && activeEmail !== emailNorm) {
      await auth.signOut();
    }

    try {
      await auth.signInWithEmailAndPassword(emailNorm, senhaNorm);
      try {
        localStorage.removeItem("firebase_sync_failed");
      } catch (_) {}
      return;
    } catch (error) {
      if (error && error.code === "auth/operation-not-allowed") {
        const hint = firebaseConfigHint();
        console.error("[Login] Firebase Email/Senha desativado. Verifique Auth > Sign-in method no projeto correto:", hint);
        throw new Error("Firebase Auth (Email/Senha) desativado no projeto. Ative em Auth > Sign-in method.");
      }

      if (error && (error.code === "auth/invalid-api-key" || error.code === "auth/app-not-authorized")) {
        const hint = firebaseConfigHint();
        console.error("[Login] ConfiguraÃ§Ã£o Firebase invÃ¡lida para este app:", hint, error);
        throw new Error("ConfiguraÃ§Ã£o do Firebase invÃ¡lida (apiKey/projeto). Revise projectId, authDomain e apiKey.");
      }

      if (error && error.code === "auth/user-not-found") {
        const gasResponse = await validarNoGAS(emailNorm, senhaNorm);

        if (gasResponse && gasResponse.status === "ok") {
          await auth.createUserWithEmailAndPassword(emailNorm, senhaNorm);
          await auth.signInWithEmailAndPassword(emailNorm, senhaNorm);
          try {
            localStorage.removeItem("firebase_sync_failed");
          } catch (_) {}
          return;
        }

        throw new Error((gasResponse && gasResponse.msg) || "E-mail ou senha incorretos.");
      }

      if (error && error.code === "auth/invalid-login-credentials") {
        const gasResponse = await validarNoGAS(emailNorm, senhaNorm);

        if (gasResponse && gasResponse.status === "ok") {
          try {
            const methods = await auth.fetchSignInMethodsForEmail(emailNorm);

            if (methods && methods.length > 0) {
              try {
                await auth.signInWithEmailAndPassword(emailNorm, senhaNorm);
                return;
              } catch (_) {
                // senha divergente â€” vamos recriar
              }
            }

            if (auth.currentUser) {
              try {
                await auth.currentUser.delete();
              } catch (_) {
                await auth.signOut();
              }
            }

            await auth.createUserWithEmailAndPassword(emailNorm, senhaNorm);
            await auth.signInWithEmailAndPassword(emailNorm, senhaNorm);
            try {
              localStorage.removeItem("firebase_sync_failed");
            } catch (_) {}
            return;
          } catch (recreateError) {
            console.error("[Login] Falha ao recriar usuÃ¡rio Firebase:", recreateError);
            throw new Error("Erro ao sincronizar credenciais com Firebase.");
          }
        }

        throw new Error("Credenciais invÃ¡lidas.");
      }

      if (error && error.code === "auth/wrong-password") {
        throw new Error("Senha incorreta. Confira sua senha e tente novamente.");
      }

      throw new Error(error?.message || "Erro ao autenticar com Firebase.");
    }
  }

  async function postGAS(p){
    const r = await fetch(scriptURL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(p)
    });
    const text = await r.text();
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${text.slice(0, 160)}`);
    }
    if (!text.trim().startsWith("{")) {
      console.error("âŒ Resposta nÃ£o-JSON:", text);
      throw new Error("Servidor retornou HTML");
    }
    try {
      return JSON.parse(text);
    } catch (err) {
      throw new Error(`Resposta invÃ¡lida do servidor: ${text.slice(0, 160)}`);
    }
  }

  /* ============================================================
     LOGIN NORMAL â€” FINAL
  ============================================================ */
  async function syncCiclo(id) {
    if (!id) return null;
    try {
      return await postGAS({ action: "sync", id });
    } catch (err) {
      console.warn("Falha ao sincronizar ciclo:", err);
      return null;
    }
  }

  async function validarPerfilAposLogin() {
    try {
      const perfil = await FEMFLOW.carregarPerfil?.();
      if (perfil?.fase && perfil?.diaCiclo) {
        localStorage.setItem("femflow_cycle_configured", "yes");
      }
      return perfil;
    } catch (err) {
      console.warn("Falha ao validar perfil:", err);
      return null;
    }
  }

  async function entrar(){
    if (loginInProgress) return;
    loginInProgress = true;

    try {
      const email = $("#loginEmail").value.trim().toLowerCase();
      const senha = $("#loginSenha").value.trim();

      if (!email){
        setErr("Digite seu e-mail.");
        return;
      }

      setMsg("Verificando...");

      let res;
      try {
        res = await postGAS({
          action: "login",
          email,
          senha,
          deviceId: FEMFLOW.getDeviceId()
        });
      } catch (e) {
        console.error(e);
        setErr("Erro ao processar resposta do servidor.");
        return;
      }

      if (res.status !== "ok") {
        if (res.status === "blocked") {
          setErr(getLoginMsg().blocked);
          FEMFLOW.clearSession?.();
          return;
        }

        if (res.status === "expired") {
          setErr(res.msg || "Sua assinatura expirou.");
          return;
        }

        if (res.status === "inactive") {
          setErr(res.msg || "Assinatura inativa.");
          return;
        }

        if (res.status === "error" && res.msg === "device_required") {
          setErr("NÃ£o foi possÃ­vel identificar o dispositivo. Tente novamente.");
          return;
        }

        if (res.status === "senha_incorreta" || res.status === "not_registered") {
          setMsg("Complete seu cadastro para continuar âœ¨");
          setTimeout(() => location.href = "anamnese_deluxe.html", 600);
          return;
        }

        setErr(res.msg || "E-mail ou senha incorretos.");
        return;
      }

      try {
        await syncFirebaseAuthSession(email, senha);
      } catch (firebaseErr) {
        console.error("[Login] Falha ao sincronizar Firebase Auth:", firebaseErr);
        try {
          localStorage.setItem("firebase_sync_failed", "true");
        } catch (_) {}
        marcarFallbackFirebaseAuth(firebaseErr?.code || firebaseErr?.message || "unknown");
        console.warn("[Login] Aplicando fallback: acesso liberado sem sessÃ£o Firebase. Recursos que exigem Firebase pedirÃ£o novo login.");
      }

      /* ===== SESSÃƒO MÃNIMA ===== */
      localStorage.setItem("femflow_auth", "yes");
      localStorage.setItem("femflow_id", res.id);
      localStorage.setItem("femflow_email", res.email || email);

      if (res.deviceId) {
        FEMFLOW.setDeviceId?.(res.deviceId || FEMFLOW.getDeviceId());
      }

      if (res.sessionToken) {
        FEMFLOW.setSessionToken(res.sessionToken);
      }
      if (res.sessionExpira) {
        FEMFLOW.setSessionExpira?.(res.sessionExpira);
      }

      await syncCiclo(res.id);
      await validarPerfilAposLogin();

  // ğŸ§  NOVO â€” reconciliaÃ§Ã£o silenciosa
  if (res.deviceUpdated) {
    console.info("ğŸ” Device atualizado automaticamente pelo backend");
  }

      setMsg("Acesso liberado âœ¨", true);
      const redirectParam = new URLSearchParams(location.search).get("redirect");
      const savedRedirect = localStorage.getItem("post_login_redirect");
      const shouldRedirectBodyInsight = redirectParam === "body_insight" || savedRedirect === "body_insight.html";
      const nextPage = shouldRedirectBodyInsight ? "body_insight.html" : "home.html";

      if (shouldRedirectBodyInsight) {
        localStorage.removeItem("post_login_redirect");
      }

      setTimeout(() => location.href = nextPage, 500);
    } finally {
      loginInProgress = false;
    }
  }


  $("#btnEntrar").onclick = entrar;
  $("#loginSenha").addEventListener("keydown", e => {
    if (e.key === "Enter") entrar();
  });

  /* ============================================================
     BARRA DE FORÃ‡A DA SENHA
  ============================================================ */
  const senhaInput = $("#loginSenha");
  const toggleEye  = $("#toggleSenha");
  const fill       = $("#strengthFill");

  toggleEye.onclick = () => {
    const isPass = senhaInput.type === "password";
    senhaInput.type = isPass ? "text" : "password";
    toggleEye.classList.toggle("active", isPass);
  };

  senhaInput.addEventListener("input", () => {
    const v = senhaInput.value;
    let score = 0;

    if (v.length >= 6) score++;
    if (/[A-Z]/.test(v) || /[0-9]/.test(v)) score++;
    if (/[^A-Za-z0-9]/.test(v) || v.length >= 10) score++;

    const map = [
      { w:0, c:"#d8d0cb" },
      { w:33, c:"#cc6a5a" },
      { w:66, c:"#e4a85f" },
      { w:100, c:"#2e7d32" }
    ];

    fill.style.width = map[score]?.w + "%";
    fill.style.background = map[score]?.c;
  });

  /* ============================================================
     LOGIN GOOGLE â€” FINAL
  ============================================================ */
  $("#googleSignIn").onclick = () => google.accounts.id.prompt();

  async function preencherComGoogle(response){
    try {
      const data = jwt_decode(response.credential);
      if (!data?.email) return;

      const res = await postGAS({
        action: "login",
        email: data.email,
        senha: "",
        deviceId: FEMFLOW.getDeviceId()
      });

      if (res.status !== "ok") {
        location.href = "anamnese_deluxe.html";
        return;
      }

      localStorage.setItem("femflow_auth", "yes");
      localStorage.setItem("femflow_id", res.id);
      localStorage.setItem("femflow_email", res.email || data.email);

      if (res.deviceId) {
        FEMFLOW.setDeviceId?.(res.deviceId || FEMFLOW.getDeviceId());
      }

      if (res.sessionToken) {
        FEMFLOW.setSessionToken(res.sessionToken);
      }
      if (res.sessionExpira) {
        FEMFLOW.setSessionExpira?.(res.sessionExpira);
      }

      await syncCiclo(res.id);
      await validarPerfilAposLogin();

      setTimeout(() => location.href = "home.html", 500);

    } catch (e) {
      console.warn("Erro Google:", e);
    }
  }
  window.preencherComGoogle = preencherComGoogle;

  /* ============================================================
     LOGIN BIOMETRIA â€” FINAL
  ============================================================ */
  const bio = $("#bioSignIn");

  (async () => {
    if (window.PublicKeyCredential &&
        await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()){
      bio.style.display = "flex";
    }
  })();

  bio.onclick = async () => {
    try {
      const email = $("#loginEmail").value.trim();
      if (!email){
        setErr("Digite seu e-mail.");
        return;
      }

      await navigator.credentials.create({
        publicKey:{
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          rp:{ name:"FemFlow" },
          user:{
            id: new TextEncoder().encode(email),
            name: email,
            displayName: email
          },
          pubKeyCredParams:[
            { type:"public-key", alg:-7 },
            { type:"public-key", alg:-257 }
          ],
          authenticatorSelection:{
            authenticatorAttachment:"platform",
            userVerification:"required"
          }
        }
      });

      const res = await postGAS({
        action: "login",
        email,
        senha: "",
        deviceId: FEMFLOW.getDeviceId()
      });

      if (res.status !== "ok") return;

      localStorage.setItem("femflow_auth", "yes");
      localStorage.setItem("femflow_id", res.id);
      localStorage.setItem("femflow_email", res.email || email);

      if (res.deviceId) {
        FEMFLOW.setDeviceId?.(res.deviceId || FEMFLOW.getDeviceId());

      }

      if (res.sessionToken) {
        FEMFLOW.setSessionToken(res.sessionToken);
      }
      if (res.sessionExpira) {
        FEMFLOW.setSessionExpira?.(res.sessionExpira);
      }

      await syncCiclo(res.id);
      await validarPerfilAposLogin();

      setMsg("Acesso liberado âœ¨", true);
      setTimeout(() => location.href = "home.html", 600);

    } catch (e) {
      console.warn(e);
      setErr("Falha ao usar biometria.");
    }
  };

  /* ============================================================
     RECUPERAR SENHA
  ============================================================ */
  $("#goRecuperar").onclick = async () => {
    const email = $("#loginEmail").value.trim().toLowerCase();
    if (!email){
      setErr("Digite seu e-mail para recuperar a senha.");
      return;
    }

    setMsg("Enviando instruÃ§Ãµes...");

    try {
      const r = await fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action:"solicitarreset", email })
      });

      const data = await r.json();
      if (data.status === "ok") setMsg("ğŸ“¬ Verifique seu e-mail!", true);
      else if (data.status === "notfound") setErr("E-mail nÃ£o encontrado.");
      else setErr("Erro ao solicitar redefiniÃ§Ã£o.");

    } catch (e){
      console.error(e);
      setErr("Erro ao enviar solicitaÃ§Ã£o.");
    }
  };

  /* ============================================================
     IDIOMA (LOGIN)
  ============================================================ */
  const modalLang = $("#ff-lang-modal");
  const btnLang   = $("#btnLoginLang");

  btnLang.onclick = () => modalLang.classList.remove("hidden");

  function aplicarIdiomaLogin(lang){
    const T = {
      pt:{ bem:"Bem-vinda", sub:"Acesse ou crie sua conta para iniciar seu ciclo", email:"Seu e-mail", senha:"Sua senha", entrar:"Entrar", cad:"Ainda nÃ£o tem conta? Cadastre-se", esq:"Esqueci minha senha" },
      en:{ bem:"Welcome", sub:"Access or create your account to start your cycle", email:"Your email", senha:"Your password", entrar:"Login", cad:"Donâ€™t have an account? Sign up", esq:"Forgot my password" },
      fr:{ bem:"Bienvenue", sub:"AccÃ©dez ou crÃ©ez votre compte pour commencer votre cycle", email:"Votre e-mail", senha:"Votre mot de passe", entrar:"Entrer", cad:"Pas de compte ? S'inscrire", esq:"Jâ€™ai oubliÃ© mon mot de passe" }
    }[lang] || T.pt;
    const labels = {
      pt: "PortuguÃªs",
      en: "English",
      fr: "FranÃ§ais"
    };

    $("#tLoginBemVinda").textContent = T.bem;
    $("#tLoginSub").textContent      = T.sub;
    $("#loginEmail").placeholder     = T.email;
    $("#loginSenha").placeholder     = T.senha;
    $("#btnEntrar").textContent      = T.entrar;
    $("#linkCadastro").textContent   = T.cad;
    $("#goRecuperar").textContent    = T.esq;
    btnLang.textContent              = `ğŸŒ ${labels[lang] || labels.pt}`;
  }

  window.setLoginLang = lang => {
    FEMFLOW.setLang?.(lang);
    localStorage.setItem("femflow_lang", lang);
    modalLang.classList.add("hidden");
    aplicarIdiomaLogin(lang);
  };

  aplicarIdiomaLogin(localStorage.getItem("femflow_lang") || "pt");
  startFirebaseAuthObserver();
  encaminharHotmartParaAnamnese();

});
</script>


<!-- ============================
      MODAL DE IDIOMA
=============================== -->
<div id="ff-lang-modal" class="ff-lang-modal hidden">
  <div class="ff-lang-box">
    <h2>ğŸŒ Idioma / Language / Langue</h2>

    <button onclick="setLoginLang('pt')" class="ff-lang-btn">ğŸ‡§ğŸ‡· PortuguÃªs</button>
    <button onclick="setLoginLang('en')" class="ff-lang-btn">ğŸ‡ºğŸ‡¸ English</button>
    <button onclick="setLoginLang('fr')" class="ff-lang-btn">ğŸ‡«ğŸ‡· FranÃ§ais</button>

    <button class="ff-lang-close"
      onclick="document.getElementById('ff-lang-modal').classList.add('hidden')">
      âœ– Fechar
    </button>
  </div>
</div>

  <script src="/app/js/env.js"></script>
</body>
</html>
