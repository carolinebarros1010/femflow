<!DOCTYPE html>
<html lang="pt-BR">

<head>
<base href="/app/" />

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <script src="./config/config.js"></script>
  <title>Entrar no FemFlow</title>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="favicon.ico">
  <meta name="msapplication-TileImage" content="favicon.ico">

  <link rel="preconnect" href="https://accounts.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://accounts.google.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://femflowapi.falling-wildflower-a8c0.workers.dev" crossorigin>
  <link rel="dns-prefetch" href="https://femflowapi.falling-wildflower-a8c0.workers.dev">


  <script>window.FEMFLOW_DISABLE_UI = true;</script>
  <script defer src="./core/femflow-core.js"></script>

  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>

  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/core.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/themes.css">
  <link rel="stylesheet" href="css/login.css">

</head>

<body class="login-page">

  <div class="login-wrapper">
    <div class="login-card">

      <img src="assets/logofemflowterracotasf.png" class="logo"/>

      <h2 id="tLoginBemVinda">Bem-vinda</h2>
      <p class="subtitle" id="tLoginSub">Acesse ou crie sua conta para iniciar seu ciclo</p>

      <button id="btnLoginLang" class="login-lang-btn">üåê Portugu√™s</button>

      <input id="loginEmail" type="email" placeholder="Seu e-mail"/>

      <div class="password-wrapper">
        <input id="loginSenha" type="password" placeholder="Sua senha">
        <span id="toggleSenha" class="toggle-eye"></span>
        <div class="password-strength">
          <div id="strengthFill" class="password-strength-fill"></div>
        </div>
      </div>

      <button id="btnEntrar" type="button">Entrar</button>
      <p id="mensagem" class="message"></p>

      <a id="linkCadastro" class="toggle" href="anamnese_deluxe.html">Ainda n√£o tem conta? Cadastre-se</a>
      <p id="goRecuperar" class="toggle">Esqueci minha senha</p>

      <div class="social-row boho">
        <div class="social-icon boho google" id="googleSignIn">
          <img src="assets/icons/google-g.svg">
        </div>

        <div class="social-icon boho apple" id="appleSignIn">
          <img src="assets/icons/apple.svg">
        </div>

        <div class="social-icon boho bio" id="bioSignIn">üîí</div>
      </div>

    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  window.FEMFLOW = window.FEMFLOW || {};

  if (FEMFLOW.bootstrapApp) {
    FEMFLOW.bootstrapApp().then((booted) => {
      if (booted) return;
    });
  }

  const scriptURL = FEMFLOW.SCRIPT_URL;

  const $ = sel => document.querySelector(sel);
  const msg = $("#mensagem");

  const setErr = t => { msg.textContent = t; msg.style.color = "#cc6a5a"; };
  const setMsg = (t, ok=false) => {
    msg.textContent = t;
    msg.style.color = ok ? "#2e7d32" : "#335953";
  };

  async function postGAS(p){
    const r = await fetch(scriptURL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(p)
    });
    const text = await r.text();
    if (!r.ok) {
      throw new Error(`HTTP ${r.status}: ${text.slice(0, 160)}`);
    }
    if (!text.trim().startsWith("{")) {
      console.error("‚ùå Resposta n√£o-JSON:", text);
      throw new Error("Servidor retornou HTML");
    }
    try {
      return JSON.parse(text);
    } catch (err) {
      throw new Error(`Resposta inv√°lida do servidor: ${text.slice(0, 160)}`);
    }
  }

  /* ============================================================
     LOGIN NORMAL ‚Äî FINAL
  ============================================================ */
  async function syncCiclo(id) {
    if (!id) return null;
    try {
      return await postGAS({ action: "sync", id });
    } catch (err) {
      console.warn("Falha ao sincronizar ciclo:", err);
      return null;
    }
  }

  async function entrar(){
    const email = $("#loginEmail").value.trim().toLowerCase();
    const senha = $("#loginSenha").value.trim();

    if (!email){
      setErr("Digite seu e-mail.");
      return;
    }

    setMsg("Verificando...");

    let res;
    try {
      res = await postGAS({
        action: "login",
        email,
        senha,
        deviceId: FEMFLOW.getDeviceId()
      });
    } catch (e) {
      console.error(e);
      setErr("Erro ao processar resposta do servidor.");
      return;
    }

    if (res.status !== "ok") {
      if (res.status === "blocked") {
        setErr("Esta conta j√° est√° conectada em outro dispositivo.");
        FEMFLOW.clearSession?.();
        return;
      }

      if (res.status === "expired") {
        setErr(res.msg || "Sua assinatura expirou.");
        return;
      }

      if (res.status === "inactive") {
        setErr(res.msg || "Assinatura inativa.");
        return;
      }

      if (res.status === "error" && res.msg === "device_required") {
        setErr("N√£o foi poss√≠vel identificar o dispositivo. Tente novamente.");
        return;
      }

      if (res.status === "senha_incorreta" || res.status === "not_registered") {
        setMsg("Complete seu cadastro para continuar ‚ú®");
        setTimeout(() => location.href = "anamnese_deluxe.html", 600);
        return;
      }

      setErr(res.msg || "E-mail ou senha incorretos.");
      return;
    }

    /* ===== SESS√ÉO M√çNIMA ===== */
    localStorage.setItem("femflow_auth", "yes");
    localStorage.setItem("femflow_id", res.id);
    localStorage.setItem("femflow_email", res.email || email);

    if (res.deviceId) {
      localStorage.setItem(
  "femflow_device_id",
  res.deviceId || FEMFLOW.getDeviceId()
);
    }

    if (res.sessionToken) {
      FEMFLOW.setSessionToken(res.sessionToken);
    }

    await syncCiclo(res.id);
    
// üß† NOVO ‚Äî reconcilia√ß√£o silenciosa
if (res.deviceUpdated) {
  console.info("üîÅ Device atualizado automaticamente pelo backend");
}
    
    setMsg("Acesso liberado ‚ú®", true);
    setTimeout(() => location.href = "home.html", 500);
  }

  $("#btnEntrar").onclick = entrar;
  $("#loginSenha").addEventListener("keydown", e => {
    if (e.key === "Enter") entrar();
  });

  /* ============================================================
     BARRA DE FOR√áA DA SENHA
  ============================================================ */
  const senhaInput = $("#loginSenha");
  const toggleEye  = $("#toggleSenha");
  const fill       = $("#strengthFill");

  toggleEye.onclick = () => {
    const isPass = senhaInput.type === "password";
    senhaInput.type = isPass ? "text" : "password";
    toggleEye.classList.toggle("active", isPass);
  };

  senhaInput.addEventListener("input", () => {
    const v = senhaInput.value;
    let score = 0;

    if (v.length >= 6) score++;
    if (/[A-Z]/.test(v) || /[0-9]/.test(v)) score++;
    if (/[^A-Za-z0-9]/.test(v) || v.length >= 10) score++;

    const map = [
      { w:0, c:"#d8d0cb" },
      { w:33, c:"#cc6a5a" },
      { w:66, c:"#e4a85f" },
      { w:100, c:"#2e7d32" }
    ];

    fill.style.width = map[score]?.w + "%";
    fill.style.background = map[score]?.c;
  });

  /* ============================================================
     LOGIN GOOGLE ‚Äî FINAL
  ============================================================ */
  $("#googleSignIn").onclick = () => google.accounts.id.prompt();

  async function preencherComGoogle(response){
    try {
      const data = jwt_decode(response.credential);
      if (!data?.email) return;

      const res = await postGAS({
        action: "login",
        email: data.email,
        senha: "",
        deviceId: FEMFLOW.getDeviceId()
      });

      if (res.status !== "ok") {
        location.href = "anamnese_deluxe.html";
        return;
      }

      localStorage.setItem("femflow_auth", "yes");
      localStorage.setItem("femflow_id", res.id);
      localStorage.setItem("femflow_email", res.email || data.email);

      if (res.deviceId) {
        localStorage.setItem(
  "femflow_device_id",
  res.deviceId || FEMFLOW.getDeviceId()
);
      }

      if (res.sessionToken) {
        FEMFLOW.setSessionToken(res.sessionToken);
      }

      await syncCiclo(res.id);

      setTimeout(() => location.href = "home.html", 500);

    } catch (e) {
      console.warn("Erro Google:", e);
    }
  }
  window.preencherComGoogle = preencherComGoogle;

  /* ============================================================
     LOGIN BIOMETRIA ‚Äî FINAL
  ============================================================ */
  const bio = $("#bioSignIn");

  (async () => {
    if (window.PublicKeyCredential &&
        await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()){
      bio.style.display = "flex";
    }
  })();

  bio.onclick = async () => {
    try {
      const email = $("#loginEmail").value.trim();
      if (!email){
        setErr("Digite seu e-mail.");
        return;
      }

      await navigator.credentials.create({
        publicKey:{
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          rp:{ name:"FemFlow" },
          user:{
            id: new TextEncoder().encode(email),
            name: email,
            displayName: email
          },
          pubKeyCredParams:[
            { type:"public-key", alg:-7 },
            { type:"public-key", alg:-257 }
          ],
          authenticatorSelection:{
            authenticatorAttachment:"platform",
            userVerification:"required"
          }
        }
      });

      const res = await postGAS({
        action: "login",
        email,
        senha: "",
        deviceId: FEMFLOW.getDeviceId()
      });

      if (res.status !== "ok") return;

      localStorage.setItem("femflow_auth", "yes");
      localStorage.setItem("femflow_id", res.id);
      localStorage.setItem("femflow_email", res.email || email);

      if (res.deviceId) {
        localStorage.setItem(
  "femflow_device_id",
  res.deviceId || FEMFLOW.getDeviceId()
);

      }

      if (res.sessionToken) {
        FEMFLOW.setSessionToken(res.sessionToken);
      }

      await syncCiclo(res.id);

      setMsg("Acesso liberado ‚ú®", true);
      setTimeout(() => location.href = "home.html", 600);

    } catch (e) {
      console.warn(e);
      setErr("Falha ao usar biometria.");
    }
  };

  /* ============================================================
     RECUPERAR SENHA
  ============================================================ */
  $("#goRecuperar").onclick = async () => {
    const email = $("#loginEmail").value.trim().toLowerCase();
    if (!email){
      setErr("Digite seu e-mail para recuperar a senha.");
      return;
    }

    setMsg("Enviando instru√ß√µes...");

    try {
      const r = await fetch(scriptURL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action:"solicitarreset", email })
      });

      const data = await r.json();
      if (data.status === "ok") setMsg("üì¨ Verifique seu e-mail!", true);
      else if (data.status === "notfound") setErr("E-mail n√£o encontrado.");
      else setErr("Erro ao solicitar redefini√ß√£o.");

    } catch (e){
      console.error(e);
      setErr("Erro ao enviar solicita√ß√£o.");
    }
  };

  /* ============================================================
     IDIOMA (LOGIN)
  ============================================================ */
  const modalLang = $("#ff-lang-modal");
  const btnLang   = $("#btnLoginLang");

  btnLang.onclick = () => modalLang.classList.remove("hidden");

  function aplicarIdiomaLogin(lang){
    const T = {
      pt:{ bem:"Bem-vinda", sub:"Acesse ou crie sua conta para iniciar seu ciclo", email:"Seu e-mail", senha:"Sua senha", entrar:"Entrar", cad:"Ainda n√£o tem conta? Cadastre-se", esq:"Esqueci minha senha" },
      en:{ bem:"Welcome", sub:"Access or create your account to start your cycle", email:"Your email", senha:"Your password", entrar:"Login", cad:"Don‚Äôt have an account? Sign up", esq:"Forgot my password" },
      fr:{ bem:"Bienvenue", sub:"Acc√©dez ou cr√©ez votre compte pour commencer votre cycle", email:"Votre e-mail", senha:"Votre mot de passe", entrar:"Entrer", cad:"Pas de compte ? S'inscrire", esq:"J‚Äôai oubli√© mon mot de passe" }
    }[lang] || T.pt;
    const labels = {
      pt: "Portugu√™s",
      en: "English",
      fr: "Fran√ßais"
    };

    $("#tLoginBemVinda").textContent = T.bem;
    $("#tLoginSub").textContent      = T.sub;
    $("#loginEmail").placeholder     = T.email;
    $("#loginSenha").placeholder     = T.senha;
    $("#btnEntrar").textContent      = T.entrar;
    $("#linkCadastro").textContent   = T.cad;
    $("#goRecuperar").textContent    = T.esq;
    btnLang.textContent              = `üåê ${labels[lang] || labels.pt}`;
  }

  window.setLoginLang = lang => {
    FEMFLOW.setLang?.(lang);
    localStorage.setItem("femflow_lang", lang);
    modalLang.classList.add("hidden");
    aplicarIdiomaLogin(lang);
  };

  aplicarIdiomaLogin(localStorage.getItem("femflow_lang") || "pt");
});
</script>


<!-- ============================
      MODAL DE IDIOMA
=============================== -->
<div id="ff-lang-modal" class="ff-lang-modal hidden">
  <div class="ff-lang-box">
    <h3 style="margin:0 0 14px; color:#335953;">Selecione o idioma</h3>

    <button onclick="setLoginLang('pt')" class="ff-lang-btn" style="background:#335953;">Portugu√™s</button>
    <button onclick="setLoginLang('en')" class="ff-lang-btn" style="background:#cc6a5a;">English</button>
    <button onclick="setLoginLang('fr')" class="ff-lang-btn" style="background:#e2b5a5; color:#573b2e;">Fran√ßais</button>

    <button class="ff-lang-close"
      onclick="document.getElementById('ff-lang-modal').classList.add('hidden')">
      Fechar
    </button>
  </div>
</div>

  <script src="/app/js/env.js"></script>
</body>
</html>
